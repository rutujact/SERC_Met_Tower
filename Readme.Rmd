---
title: "MetTower Readme and Updater"
author: "Rutuja Chitra-Tarak"
date: "7/19/2019"
output: html_document
---

```{r setup, include = FALSE, echo = TRUE, eval = TRUE, warning = FALSE, message = FALSE}
```

## How to update this package

This package can be updated by knitting this file (with eval = TRUE in opts_chunk above). Before knitting in order to update to the latest year you will have to (1) set the current 'year' in Chunk 1, as well as, set the 'from.copy.path' to the local path of MET_TOWER folder (change if Rutuja is not updating), and (2) add Pat Neal's QAQCd radiation data file location in Chunk 3; if there is a new file for the latest year (last version was through 2018).

### 1. fun.get_minute_by_year

This function pulls minute data from MetTower folder, where it is downloaded by Jess Shue (typically monthly) from the Photobio lab shared folder (if not, you may have to remind her). It is copied into the current project data-raw folder. It then collates minute data of a year into a single file. Often only data for the current, incomplete year needs to be collated. Avoid compiling earlier years again, as it takes a long time.  

```{r, Chunk 1, eval = FALSE}
# Set current year
# If you wish to collate older years too, then turn old.years = TRUE
year <- 2019
from.copy.path <- "/Users/rutuja/Dropbox (Smithsonian)/Work_at_SERC/Data/SERC_Met_data/MET_TOWER/"
old.years <- TRUE
source("data-raw/functions_to_source_data.R")
fun.get_minute_by_year(year = year, from.copy.path = from.copy.path, old.years = old.years)
```


### 2. fun.minute_by_year_into_one_file

This function combines minute data by year files into one single large file, named with initial and last years. Often only the current year needs to be appended to the older multi-year file to generate a new one.

```{r, Chunk 2, eval = FALSE}
# older file is identified as 2003- (year - 1)
# year set as in the current year above
# if you wish to collate older years too, then turn old.years = TRUE
source("data-raw/functions_to_source_data.R")
# old.years <- FALSE # taken as set in Chunk 1
fun.minute_by_year_into_one_file(year = year, old.years = old.years)
```

### 3. fun.mettower 

This function is the main package function. It does a lot of data vetting and generates .Rda data and installs package:

1. Reads in and substitutes radiation QAQCd data given by Pat Neale:
  Currently until year 2018. Pat usually generates QAQCd data after the end of the year.1. Converts mettower minute data above into desired units as in Table 1.

2. Cleans by removing: 
    a. Data in date range within which it is known to be bad, as given in data-raw/MetTower_T RH Record Documentation_Pat_Neale).
        Note that years worth of data are missing: Met Tmax, Tmin, RHmin, RHmax (that is forest floor) readings problematic from August 1, 2013 until end of 2014.
        Met Tmax.tower, Tmin.tower, RHmin.tower, RHmax.tower (that is tower-top) readings problematic from Jan 2015 - March 9, 2017 (new unit since 3/9/2017). 
        Temp.tower is removed when RH.tower > 100 during 2015-01-01 to 2015-11-13 and 2016-08-02 to 2017-03-09. RH.tower is flagged in column tower.RH.Flag as 0 from 2015-01-01 to 2015-11-13 (records ~ 6% lower RH), while from 2016-08-02 to 2017-03-09 RH.tower is removed.

        SVP/Saturated Vapour Pressure is derived using Temp and RH based on Buck's equation.
        
    b. Data beyond acceptable range across all period as in Table 1.
       Also Temp < 4 deg c in summer (doy > 150 & doy < 330) also removed.
       
       mettower_minute.Rda (also .csv) are generated at this stage. ~364 MB size with default 'bzip2' compression. This can be saved with 'xz' compression to reduce file size, but saves and loads quite slow.
4. Daily summaries are then created at this stage. For Temp and RH they are Tmax, Tmin, RHmax, RHmin. Unreasonable summer values are removed. Summer is defined as  doy > 150 & doy < 330. RHmax in summer below 30% is considered unacceptable, RHmin below 10%, Tmax below 4 deg C and Tmin below 0 deg C

    This data is now stored as mettower.Rda (also .txt).

5. Gap-filling: Daily summaries of missing data as well as data removed as above, ---for Forest Floor alone-- are gap-filled from green-house data.
    Gap-filled version is stored as metbottom.filled.Rda (also .txt). It retains daily summaries for Tower-Top, which are not gap-filled.
6. Generates graphs for daily and annual summaries. Also a graph comparing daily data for forest floor versus tower-top. See project folder 'figures/'
7. Finally, calculates and plots climatic mean and SE (for doy across years) for each variable.
8. mettower package is installed and attached.

#### The following chunk takes 45 min to run on Rutuja's 8GB RAM Intel Core i5

```{r, Chunk 3, eval = FALSE}
# Refers to Chunk 3.2.b above
# Set unacceptable data range
# If you were to change this range, set it here
year <- 2019
df_dict0 <-
  data.frame(
    variable = c("Precip.tower", "Ws.tower", "Bp.tower", "Rs.floor", "Rs.tower", "Temp.floor", "Temp.tower", "RH.floor", "RH.tower", "SVP.floor", "SVP.tower"),
    out_low = c(0, 0, 90, 0, 0, -25, -25, 0, 0, 0, 0),
    out_high = c(300, 50, 104, 30, 40, 50, 50, 100, 100, 10, 10)
  )
##--
## Referes to Chunk 3.3 above
met.Rs.QC.1 <- read.csv("data-raw/MetTower_Rs_data_from_Pat_Neale/TowerWoodsPSP02_17.csv",
                      na.strings = c("NA", "NaN", ""),
                      header = FALSE,
                      row.names = NULL,
                      check.names = F)
met.Rs.QC.2 <- read.csv("data-raw/MetTower_Rs_data_from_Pat_Neale/TowerWoodsPSP18.csv",
                      na.strings = c("NA", "NaN", ""),
                      header = FALSE,
                      row.names = NULL,
                      check.names = F)
met.Rs.QC.3 <- rbind.data.frame(met.Rs.QC.1, met.Rs.QC.2)
##--
source("data-raw/fun.mettower.R")
# year as in the current year set above
fun.mettower(year = year, df_dict0 = df_dict0, met.Rs.QC = met.Rs.QC)
```


```{r, Chunk 4, eval = FALSE}
## Plotting graphs
load(file = paste0("figures/graphs.list.Rda"))
load(file = paste0("figures/graphs.list.func.Rda"))
load(file = paste0("data/mettower.Rda"))
load(file = paste0("data-raw/minute_data_all_years_metric_raw.Rda"))

graphs.list[[1]]
graphs.list$plot.datagaps.1(met3)
graphs.list[[2]]
graphs.list$plot.datagaps.2(mettower)
for (i in 3: length(graphs.list)){
  graphs.list[[i]]
}
```


##### Table 1: Minute data in metttower_minute.Rda

Variables 'Temp', 'RH', 'Rs' refer to Forest Floor. Those for Tower-Top have the '.tower' suffix.

Column Header  | Variable | Lower limit | Upper limit | Units
------------- | -------------------------- | ------------- | ------------- | -------------
Precip.tower  | Precipitation | 0 | 300 | mm
Ws.tower      | Wind speed measured at tower height | 0 | 50 | m/s
Bp.tower      | Vapour Pressure | 90 | 104 | kPa
Rs.floor      | Incoming Solar Radiation at Forest Floor| 0 | 12 | MJ/m2/day
Rs.tower      | Incoming Solar Radiation at Tower-Top | 0 | 12 | MJ/m2/day
Temp.floor    | Temperature at Forest Floor| -25 | 50 | degree celcius
Temp.tower    | Temperature at Tower-Top | -25 | 50 | degree celcius
RH.floor      | Relative Humidity at Forest Floor| 0 | 100 | %
RH.tower      | Relative Humidity at Tower-Top | 0 | 100 | %
tower.RH.Flag | 0 = RH falls in problematic date-range 2015-01-01 to 2015-11-13, else 1
SVP.floor | Saturated Vapor Pressure at Forest Floor | 0 | 20 | kPa
SVP.tower | Saturated Vapor Pressure at Tower-Top |  0 | 20 | kPa
VPD.floor | Vapor Pressure Deficit at Forest Floor | NA | NA | kPa
VPD.tower | Vapor Pressure Deficit at Tower-Top | NA | NA | kPa
  

##### Table 2: Daily summaries in mettower.Rda or metbottom.filled.Rda

Variables 'Tmax', 'Tmin', 'RHmax', 'RHmin', 'Rs' refer to Forest Floor. Those for Tower-Top have the '.tower' suffix and have the same units.

Column Header  | Variable | Unit 
------------- | -------------------------------------- | -------------
Precip.tower  | Daily total Precipitation | mm
Ws.tower      | Daily mean wind speed measured at tower height | m/s
Bp.tower      | Daily mean Vapour Pressure | kPa
Rs.floor      | Daily mean Incoming Solar Radiation at Forest Floor | MJ/m^2^/day
Rs.tower      | Daily mean Incoming Solar Radiation at Tower-Top | MJ/m^2^/day
Tmax.floor    | Daily Maximum Temperature at Forest Floor| degree Celcius
Tmax.tower    | Daily Maximum Temperature at Tower-Top | degree Celcius
Tmin.floor    | Daily Minimum Temperature at Forest Floor| degree Celcius
Tmin.tower    | Daily Minimum Temperature at Tower-Top | degree Celcius
RHmax.floor   | Daily Maximum Relative Humidity at Forest Floor| %
RHmax.tower   | Daily Maximum Relative Humidity at Tower-Top | %
RHmin.floor   | Daily Minimum Relative Humidity at Forest Floor| %
RHmin.tower   | Daily Minimum Relative Humidity at Tower-Top | %
tower.RH.Flag | 0 = day that contains at least one minute datum that falls in problematic date-range 2015-01-01 to 2015-11-13, else 1
SVPmax.floor | Daily Maximum Saturated Vapor Pressure at Forest Floor | kPa
SVPmax.tower | Daily Maximum Saturated Vapor Pressure at Tower-Top | kPa
VPDmax.floor | Daily Maximum Vapor Pressure Deficit at Forest Floor | kPa
VPDmax.tower | Daily Maximum Vapor Pressure Deficit at Tower-Top | kPa


```{r image-ref-for-in-text, echo = FALSE, message=FALSE, fig.align='center', fig.cap='Some cool caption', out.width='0.75\\linewidth', fig.pos='H'}
knitr::include_graphics("figures/Tower Temp offset changes by 10 deg C 2017-03-09 onwards.pdf")
```


"figures/mettower Raw Data Daily Means in SI units.pdf"
"figures/Daily MetTower cleaned Rs data from Pat Neale Tower-Top & Forest floor.pdf"
"figures/mettower_daily_gap.pdf"
"figures/daily_met_data_by_year_Tower-Top.pdf"
"figures/annual_met_data.pdf"
"figures/daily_met_data_by_year_forestfloor.pdf"
"figures/Tower Top vs. Forest Floor.pdf"
"figures/Tower Top vs. Forest Floor_mean & SE.pdf"
